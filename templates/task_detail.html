{% extends "base.html" %}

{% block title %}ä»»åŠ¡è¯¦æƒ… #{{ task_id }} - MySQL to ClickHouse è¿ç§»å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        padding: 32px;
        width: 100%;
    }
    .page-title {
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title::before {
        content: 'ğŸ“Š';
        font-size: 32px;
    }
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
    }
    .section {
        margin-bottom: 32px;
    }
    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .info-item {
        padding: 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 10px;
        border: 1px solid var(--border-color);
        transition: all 0.3s;
    }
    .info-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    .info-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    .info-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }
    .status {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }
    .status.running {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info-color);
    }
    .status.completed {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }
    .status.failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }
    .status.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 16px;
        border-radius: 8px;
        overflow: hidden;
    }
    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    th {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 13px;
    }
    tbody tr {
        transition: all 0.2s;
    }
    tbody tr:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    .log-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1.5px solid var(--border-color);
        border-radius: 10px;
        padding: 16px;
        background: #1e293b;
        color: #e2e8f0;
        font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
        font-size: 13px;
        line-height: 1.6;
    }
    .log-entry {
        margin-bottom: 6px;
        padding: 4px 0;
    }
    .log-INFO {
        color: #34d399;
    }
    .log-WARNING {
        color: #fbbf24;
    }
    .log-ERROR {
        color: #f87171;
    }
    .log-DEBUG {
        color: #60a5fa;
    }
    .config-preview {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1.5px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        margin-top: 16px;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
    }
    .config-item {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }
    .config-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .config-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
        font-size: 13px;
    }
    .config-value {
        color: var(--text-secondary);
        font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
        font-size: 13px;
        background: var(--card-bg);
        padding: 8px 12px;
        border-radius: 6px;
        display: inline-block;
    }
    .tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 24px;
        gap: 8px;
    }
    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
        border-radius: 8px 8px 0 0;
    }
    .tab:hover {
        color: var(--primary-color);
        background: rgba(99, 102, 241, 0.05);
    }
    .tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        font-weight: 600;
        background: rgba(99, 102, 241, 0.05);
    }
    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <h1 class="page-title">ä»»åŠ¡è¯¦æƒ… #{{ task_id }}</h1>
    <p class="page-subtitle">æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè¯¦æƒ…ã€æ—¥å¿—å’Œé…ç½®ä¿¡æ¯</p>
    
    <div id="taskInfo">
        <div class="section">
            <div class="section-title">ğŸ“‹ ä»»åŠ¡ä¿¡æ¯</div>
            <div class="info-grid" id="infoGrid">
                <div class="info-item">
                    <div class="info-label">ä»»åŠ¡åç§°</div>
                    <div class="info-value" id="taskName">åŠ è½½ä¸­...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">çŠ¶æ€</div>
                    <div class="info-value" id="taskStatus">åŠ è½½ä¸­...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¼€å§‹æ—¶é—´</div>
                    <div class="info-value" id="startTime">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç»“æŸæ—¶é—´</div>
                    <div class="info-value" id="endTime">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€»è¡¨æ•°</div>
                    <div class="info-value" id="totalTables">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æˆåŠŸ/å¤±è´¥</div>
                    <div class="info-value" id="successFailed">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€»è¡Œæ•°</div>
                    <div class="info-value" id="totalRows">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ€»è€—æ—¶</div>
                    <div class="info-value" id="totalTime">-</div>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('tables')">ğŸ“Š è¡¨è¿ç§»è¯¦æƒ…</button>
            <button class="tab" onclick="switchTab('logs')">ğŸ“ ä»»åŠ¡æ—¥å¿—</button>
            <button class="tab" onclick="switchTab('config')">âš™ï¸ é…ç½®å¿«ç…§</button>
        </div>
        
        <div id="tables-tab" class="tab-content active">
            <div class="section">
                <div class="section-title">è¡¨è¿ç§»è¯¦æƒ…</div>
                <table id="tablesTable">
                    <thead>
                        <tr>
                            <th>MySQLè¡¨</th>
                            <th>ClickHouseè¡¨</th>
                            <th>çŠ¶æ€</th>
                            <th>è¡Œæ•°</th>
                            <th>è€—æ—¶</th>
                            <th>é€Ÿåº¦</th>
                            <th>éªŒè¯</th>
                        </tr>
                    </thead>
                    <tbody id="tablesBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px;">
                                åŠ è½½ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="logs-tab" class="tab-content">
            <div class="section">
                <div class="section-title">ä»»åŠ¡æ—¥å¿—</div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div id="config-tab" class="tab-content">
            <div class="section">
                <div class="section-title">é…ç½®å¿«ç…§</div>
                <div class="config-preview" id="configPreview">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const taskId = {{ task_id }};
    let autoRefresh = true;

    function switchTab(tabName) {
        // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

    function renderConfigPreview(config) {
        if (!config) return 'æ— é…ç½®ä¿¡æ¯';
        
        let html = '';
        
        if (config.mysql) {
            html += `
                <div class="config-item">
                    <div class="config-label">ğŸ—„ï¸ MySQL æ•°æ®åº“</div>
                    <div class="config-value">${config.mysql.host}:${config.mysql.port} / ${config.mysql.database}</div>
                </div>
            `;
        }
        
        if (config.clickhouse) {
            html += `
                <div class="config-item">
                    <div class="config-label">âš¡ ClickHouse æ•°æ®åº“</div>
                    <div class="config-value">${config.clickhouse.host}:${config.clickhouse.port} / ${config.clickhouse.database}</div>
                </div>
            `;
        }
        
        if (config.migration && config.migration.tables) {
            html += `
                <div class="config-item">
                    <div class="config-label">ğŸ“¦ è¿ç§»è¡¨åˆ—è¡¨</div>
                    <div class="config-value">${config.migration.tables.map(t => `${t.mysql_table} â†’ ${t.ch_table}`).join(', ')}</div>
                </div>
            `;
        }
        
        if (config.migration) {
            html += `
                <div class="config-item">
                    <div class="config-label">âš™ï¸ é»˜è®¤æ‰¹æ¬¡å¤§å°</div>
                    <div class="config-value">${config.migration.default_batch_size || 10000}</div>
                </div>
            `;
        }
        
        return html || 'æ— é…ç½®ä¿¡æ¯';
    }

    async function loadTaskDetail() {
        try {
            const response = await fetch(`/api/task/${taskId}`);
            const data = await response.json();
            
            const task = data.task;
            const logs = data.logs || [];
            const tableMigrations = data.table_migrations || [];
            
            // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
            document.getElementById('taskName').textContent = task.task_name || '-';
            document.getElementById('taskStatus').innerHTML = 
                `<span class="status ${task.status}">${getStatusText(task.status)}</span>`;
            document.getElementById('startTime').textContent = task.start_time || '-';
            document.getElementById('endTime').textContent = task.end_time || '-';
            document.getElementById('totalTables').textContent = task.total_tables || 0;
            document.getElementById('successFailed').textContent = 
                `${task.success_tables || 0}/${task.failed_tables || 0}`;
            document.getElementById('totalRows').textContent = 
                task.total_rows ? formatNumber(task.total_rows) : '-';
            document.getElementById('totalTime').textContent = 
                task.total_time ? formatTime(task.total_time) : '-';
            
            // æ›´æ–°è¡¨è¿ç§»è¯¦æƒ…
            const tbody = document.getElementById('tablesBody');
            if (tableMigrations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            æš‚æ— è¡¨è¿ç§»è®°å½•
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = tableMigrations.map(tm => {
                    return `
                        <tr>
                            <td><strong>${tm.mysql_table}</strong></td>
                            <td><strong>${tm.ch_table}</strong></td>
                            <td><span class="status ${tm.status}">${getStatusText(tm.status)}</span></td>
                            <td>${tm.rows ? formatNumber(tm.rows) : '-'}</td>
                            <td>${tm.time_used ? formatTime(tm.time_used) : '-'}</td>
                            <td>${tm.speed ? formatNumber(Math.round(tm.speed)) + ' rows/s' : '-'}</td>
                            <td>${tm.verified ? 'âœ…' : 'âŒ'}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // æ›´æ–°æ—¥å¿—
            const logContainer = document.getElementById('logContainer');
            if (logs.length === 0) {
                logContainer.innerHTML = '<div class="log-entry">æš‚æ— æ—¥å¿—</div>';
            } else {
                logContainer.innerHTML = logs.reverse().map(log => {
                    return `
                        <div class="log-entry log-${log.log_level}">
                            [${log.log_time}] [${log.log_level}] ${escapeHtml(log.log_message)}
                        </div>
                    `;
                }).join('');
                // æ»šåŠ¨åˆ°åº•éƒ¨
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // æ›´æ–°é…ç½®é¢„è§ˆ
            if (task.config_snapshot) {
                document.getElementById('configPreview').innerHTML = renderConfigPreview(task.config_snapshot);
            }
            
            // å¦‚æœä»»åŠ¡å·²å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
            if (task.status === 'completed' || task.status === 'failed') {
                autoRefresh = false;
            }
        } catch (error) {
            console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'running': 'ğŸ”„ è¿è¡Œä¸­',
            'completed': 'âœ… å·²å®Œæˆ',
            'failed': 'âŒ å¤±è´¥',
            'success': 'âœ… æˆåŠŸ'
        };
        return statusMap[status] || status || 'æœªçŸ¥';
    }

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatTime(seconds) {
        if (seconds < 60) {
            return Math.round(seconds) + 's';
        } else if (seconds < 3600) {
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return m + 'm ' + s + 's';
        } else {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return h + 'h ' + m + 'm';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // åˆå§‹åŠ è½½
    loadTaskDetail();
    
    // å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡
    if (autoRefresh) {
        setInterval(() => {
            if (autoRefresh) {
                loadTaskDetail();
            }
        }, 2000);
    }
</script>
{% endblock %}
