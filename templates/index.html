{% extends "base.html" %}

{% block title %}é…ç½®ç®¡ç† - MySQL to ClickHouse è¿ç§»å·¥å…·{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        display: grid;
        grid-template-columns: 900px 360px;
        gap: 24px;
        margin: 0 auto;
        justify-content: center;
    }
    .main-panel {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        padding: 32px;
        width: 900px;
        transition: box-shadow 0.3s;
    }
    .main-panel:hover {
        box-shadow: var(--shadow-lg);
    }
    .sidebar-panel {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        padding: 24px;
        height: fit-content;
        position: sticky;
        top: 24px;
    }
    .page-title {
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 28px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title::before {
        content: 'âš™ï¸';
        font-size: 32px;
    }
    .page-subtitle {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 24px;
    }
    .section {
        margin-bottom: 32px;
    }
    .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .form-group {
        margin-bottom: 18px;
    }
    label {
        display: block;
        margin-bottom: 6px;
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
    }
    input[type="text"], input[type="number"], input[type="password"], 
    textarea, select {
        width: 100%;
        padding: 10px 14px;
        border: 1.5px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        background: var(--card-bg);
        color: var(--text-primary);
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .table-config {
        border: 1.5px solid var(--border-color);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 16px;
        background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
        transition: all 0.3s;
    }
    .table-config:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-sm);
    }
    .table-config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .table-config-header strong {
        color: var(--text-primary);
        font-size: 15px;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: var(--shadow-sm);
    }
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }
    .btn:active {
        transform: translateY(0);
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--success-color) 0%, var(--success-hover) 100%);
        color: white;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, var(--success-hover) 0%, #047857 100%);
    }
    .btn-primary::before {
        content: 'ğŸš€';
    }
    .btn-danger {
        background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-hover) 100%);
        color: white;
    }
    .btn-danger:hover {
        background: linear-gradient(135deg, var(--danger-hover) 0%, #b91c1c 100%);
    }
    .btn-secondary {
        background: linear-gradient(135deg, var(--info-color) 0%, #2563eb 100%);
        color: white;
    }
    .btn-secondary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    .btn-secondary::before {
        content: 'â•';
    }
    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }
    .actions {
        display: flex;
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1.5px solid var(--border-color);
    }
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }
    .message {
        padding: 14px 18px;
        border-radius: 8px;
        margin-bottom: 24px;
        display: none;
        animation: slideDown 0.3s ease;
        border-left: 4px solid;
    }
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .message.success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        border-left-color: var(--success-color);
    }
    .message.error {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
        border-left-color: var(--danger-color);
    }
    .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .sidebar-title::before {
        content: 'ğŸ“Š';
    }
    .task-item {
        padding: 14px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 10px;
        border-left: 4px solid var(--border-color);
        cursor: pointer;
        transition: all 0.3s;
    }
    .task-item:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }
    .task-item.running {
        border-left-color: var(--info-color);
    }
    .task-item.completed {
        border-left-color: var(--success-color);
    }
    .task-item.failed {
        border-left-color: var(--danger-color);
    }
    .task-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 6px;
        font-size: 14px;
    }
    .task-meta {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .task-status {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }
    .task-status.running {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info-color);
    }
    .task-status.completed {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
    }
    .task-status.failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }
    .view-all-link {
        display: block;
        text-align: center;
        margin-top: 16px;
        color: var(--primary-color);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .view-all-link:hover {
        background: rgba(99, 102, 241, 0.1);
        text-decoration: none;
    }
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
        font-size: 14px;
    }
    .empty-state::before {
        content: 'ğŸ“­';
        display: block;
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="main-panel">
        <h1 class="page-title">é…ç½®ç®¡ç†</h1>
        <p class="page-subtitle">é…ç½®MySQLå’ŒClickHouseæ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œè®¾ç½®è¿ç§»å‚æ•°</p>
        
        <div id="message" class="message"></div>
        
        <form id="configForm">
            <!-- MySQLé…ç½® -->
            <div class="section">
                <div class="section-title">ğŸ—„ï¸ MySQL æ•°æ®åº“é…ç½®</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä¸»æœºåœ°å€</label>
                        <input type="text" name="mysql.host" id="mysql_host" required>
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£</label>
                        <input type="number" name="mysql.port" id="mysql_port" value="3306" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" name="mysql.user" id="mysql_user" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" name="mysql.password" id="mysql_password" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ•°æ®åº“å</label>
                        <input type="text" name="mysql.database" id="mysql_database" required>
                    </div>
                    <div class="form-group">
                        <label>å­—ç¬¦é›†</label>
                        <input type="text" name="mysql.charset" id="mysql_charset" value="utf8mb4">
                    </div>
                </div>
            </div>

            <!-- ClickHouseé…ç½® -->
            <div class="section">
                <div class="section-title">âš¡ ClickHouse æ•°æ®åº“é…ç½®</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä¸»æœºåœ°å€</label>
                        <input type="text" name="clickhouse.host" id="clickhouse_host" required>
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£</label>
                        <input type="number" name="clickhouse.port" id="clickhouse_port" value="8123" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" name="clickhouse.user" id="clickhouse_user" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" name="clickhouse.password" id="clickhouse_password" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ•°æ®åº“å</label>
                    <input type="text" name="clickhouse.database" id="clickhouse_database" required>
                </div>
            </div>

            <!-- è¿ç§»ä»»åŠ¡é…ç½® -->
            <div class="section">
                <div class="section-title">ğŸ“¦ è¿ç§»ä»»åŠ¡é…ç½®</div>
                <div id="tablesContainer"></div>
                <button type="button" class="btn btn-secondary" onclick="addTable()">æ·»åŠ è¡¨</button>
                
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>é»˜è®¤æ‰¹æ¬¡å¤§å°</label>
                        <input type="number" name="migration.default_batch_size" id="default_batch_size" value="10000">
                    </div>
                    <div class="form-group">
                        <label>æ—¥å¿—é—´éš”(ç§’)</label>
                        <input type="number" name="migration.log_interval" id="log_interval" value="3">
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="migration.default_verify" id="default_verify" checked>
                        <label for="default_verify">é»˜è®¤éªŒè¯æ•°æ®</label>
                    </div>
                </div>
            </div>

            <!-- æ—¥å¿—é…ç½® -->
            <div class="section">
                <div class="section-title">ğŸ“ æ—¥å¿—é…ç½®</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥å¿—çº§åˆ«</label>
                        <select name="logging.level" id="logging_level">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO" selected>INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ—¥å¿—æ–‡ä»¶å‰ç¼€</label>
                        <input type="text" name="logging.file_prefix" id="file_prefix" value="migration">
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="logging.console_output" id="console_output" checked>
                        <label for="console_output">æ§åˆ¶å°è¾“å‡º</label>
                    </div>
                </div>
            </div>

            <!-- æ€§èƒ½é…ç½® -->
            <div class="section">
                <div class="section-title">âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>MySQLè·å–å¤§å°</label>
                        <input type="number" name="performance.mysql_fetch_size" id="mysql_fetch_size" value="1000">
                    </div>
                    <div class="form-group">
                        <label>è¿æ¥è¶…æ—¶(ç§’)</label>
                        <input type="number" name="performance.connection_timeout" id="connection_timeout" value="30">
                    </div>
                </div>
                <div class="form-group">
                    <label>è¯»å–è¶…æ—¶(ç§’)</label>
                    <input type="number" name="performance.read_timeout" id="read_timeout" value="60">
                </div>
            </div>

            <!-- é«˜çº§é€‰é¡¹ -->
            <div class="section">
                <div class="section-title">ğŸ”§ é«˜çº§é€‰é¡¹</div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="advanced.drop_table_before_create" id="drop_table_before_create" checked>
                        <label for="drop_table_before_create">åˆ›å»ºå‰åˆ é™¤è¡¨</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="advanced.skip_empty_tables" id="skip_empty_tables" checked>
                        <label for="skip_empty_tables">è·³è¿‡ç©ºè¡¨</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="advanced.continue_on_error" id="continue_on_error">
                        <label for="continue_on_error">å‡ºé”™æ—¶ç»§ç»­</label>
                    </div>
                </div>
            </div>

            <!-- é£ä¹¦é€šçŸ¥é…ç½® -->
            <div class="section">
                <div class="section-title">ğŸ“¢ é£ä¹¦é€šçŸ¥é…ç½®</div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="feishu.enabled" id="feishu_enabled" checked>
                        <label for="feishu_enabled">å¯ç”¨é£ä¹¦é€šçŸ¥</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Webhook URL</label>
                    <input type="text" name="feishu.webhook_url" id="feishu_webhook_url" style="width: 100%;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç¯å¢ƒåç§°</label>
                        <input type="text" name="feishu.env_name" id="feishu_env_name" value="æµ‹è¯•ç¯å¢ƒ">
                    </div>
                    <div class="form-group">
                        <label>é¡¹ç›®åç§°</label>
                        <input type="text" name="feishu.project_name" id="feishu_project_name" value="æ•°æ®è¿ç§»ç³»ç»Ÿ">
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="feishu.notify_on_start" id="notify_on_start" checked>
                        <label for="notify_on_start">ä»»åŠ¡å¼€å§‹æ—¶é€šçŸ¥</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="feishu.notify_on_success" id="notify_on_success" checked>
                        <label for="notify_on_success">ä»»åŠ¡æˆåŠŸæ—¶é€šçŸ¥</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="feishu.notify_on_failure" id="notify_on_failure" checked>
                        <label for="notify_on_failure">ä»»åŠ¡å¤±è´¥æ—¶é€šçŸ¥</label>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button type="button" class="btn btn-primary" onclick="startMigration()">å¯åŠ¨è¿ç§»ä»»åŠ¡</button>
            </div>
        </form>
    </div>
    
    <div class="sidebar-panel">
        <div class="sidebar-title">æœ€è¿‘ä»»åŠ¡</div>
        <div id="recentTasks">
            <div class="empty-state">åŠ è½½ä¸­...</div>
        </div>
        <a href="/tasks" class="view-all-link">æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ â†’</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let tableIndex = 0;

    // åŠ è½½é…ç½®
    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            
            // å¡«å……è¡¨å•
            if (config.mysql) {
                document.getElementById('mysql_host').value = config.mysql.host || '';
                document.getElementById('mysql_port').value = config.mysql.port || 3306;
                document.getElementById('mysql_user').value = config.mysql.user || '';
                document.getElementById('mysql_password').value = config.mysql.password || '';
                document.getElementById('mysql_database').value = config.mysql.database || '';
                document.getElementById('mysql_charset').value = config.mysql.charset || 'utf8mb4';
            }
            
            if (config.clickhouse) {
                document.getElementById('clickhouse_host').value = config.clickhouse.host || '';
                document.getElementById('clickhouse_port').value = config.clickhouse.port || 8123;
                document.getElementById('clickhouse_user').value = config.clickhouse.user || '';
                document.getElementById('clickhouse_password').value = config.clickhouse.password || '';
                document.getElementById('clickhouse_database').value = config.clickhouse.database || '';
            }
            
            if (config.migration) {
                document.getElementById('default_batch_size').value = config.migration.default_batch_size || 10000;
                document.getElementById('log_interval').value = config.migration.log_interval || 3;
                document.getElementById('default_verify').checked = config.migration.default_verify !== false;
                
                if (config.migration.tables && config.migration.tables.length > 0) {
                    config.migration.tables.forEach(table => {
                        addTable(table.mysql_table, table.ch_table, table.batch_size, table.verify);
                    });
                } else {
                    addTable();
                }
            } else {
                addTable();
            }
            
            if (config.logging) {
                document.getElementById('logging_level').value = config.logging.level || 'INFO';
                document.getElementById('file_prefix').value = config.logging.file_prefix || 'migration';
                document.getElementById('console_output').checked = config.logging.console_output !== false;
            }
            
            if (config.performance) {
                document.getElementById('mysql_fetch_size').value = config.performance.mysql_fetch_size || 1000;
                document.getElementById('connection_timeout').value = config.performance.connection_timeout || 30;
                document.getElementById('read_timeout').value = config.performance.read_timeout || 60;
            }
            
            if (config.advanced) {
                document.getElementById('drop_table_before_create').checked = config.advanced.drop_table_before_create !== false;
                document.getElementById('skip_empty_tables').checked = config.advanced.skip_empty_tables !== false;
                document.getElementById('continue_on_error').checked = config.advanced.continue_on_error || false;
            }
            
            if (config.feishu) {
                document.getElementById('feishu_enabled').checked = config.feishu.enabled !== false;
                document.getElementById('feishu_webhook_url').value = config.feishu.webhook_url || '';
                document.getElementById('feishu_env_name').value = config.feishu.env_name || 'æµ‹è¯•ç¯å¢ƒ';
                document.getElementById('feishu_project_name').value = config.feishu.project_name || 'æ•°æ®è¿ç§»ç³»ç»Ÿ';
                document.getElementById('notify_on_start').checked = config.feishu.notify_on_start !== false;
                document.getElementById('notify_on_success').checked = config.feishu.notify_on_success !== false;
                document.getElementById('notify_on_failure').checked = config.feishu.notify_on_failure !== false;
            }
        } catch (error) {
            showMessage('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // åŠ è½½æœ€è¿‘ä»»åŠ¡
    async function loadRecentTasks() {
        try {
            const response = await fetch('/api/tasks/recent?limit=5');
            const tasks = await response.json();
            
            const container = document.getElementById('recentTasks');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— ä»»åŠ¡è®°å½•</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                const statusClass = task.status || 'unknown';
                const statusText = getStatusText(task.status);
                const time = task.start_time || '-';
                
                return `
                    <div class="task-item ${statusClass}" onclick="window.location.href='/task/${task.id}'">
                        <div class="task-name">${task.task_name || `ä»»åŠ¡ #${task.id}`}</div>
                        <div class="task-meta">
                            <span>${time}</span>
                            <span class="task-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            document.getElementById('recentTasks').innerHTML = 
                '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'running': 'è¿è¡Œä¸­',
            'completed': 'å·²å®Œæˆ',
            'failed': 'å¤±è´¥'
        };
        return statusMap[status] || status || 'æœªçŸ¥';
    }

    // æ·»åŠ è¡¨é…ç½®
    function addTable(mysqlTable = '', chTable = '', batchSize = '', verify = true) {
        const container = document.getElementById('tablesContainer');
        const index = tableIndex++;
        const div = document.createElement('div');
        div.className = 'table-config';
        div.id = `table-${index}`;
        div.innerHTML = `
            <div class="table-config-header">
                <strong>è¡¨é…ç½® #${index + 1}</strong>
                <button type="button" class="btn btn-danger btn-small" onclick="removeTable(${index})">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>MySQLè¡¨å</label>
                    <input type="text" name="mysql_table_${index}" value="${mysqlTable}" required>
                </div>
                <div class="form-group">
                    <label>ClickHouseè¡¨å</label>
                    <input type="text" name="ch_table_${index}" value="${chTable}" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ‰¹æ¬¡å¤§å°</label>
                    <input type="number" name="batch_size_${index}" value="${batchSize}">
                </div>
                <div class="form-group">
                    <div class="checkbox-group" style="margin-top: 25px;">
                        <input type="checkbox" name="verify_${index}" ${verify ? 'checked' : ''}>
                        <label>éªŒè¯æ•°æ®</label>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(div);
    }

    // åˆ é™¤è¡¨é…ç½®
    function removeTable(index) {
        const element = document.getElementById(`table-${index}`);
        if (element) {
            element.remove();
        }
    }

    // æ”¶é›†è¡¨å•æ•°æ®
    function collectFormData() {
        const formData = {};
        
        // MySQLé…ç½®
        formData.mysql = {
            host: document.getElementById('mysql_host').value,
            port: parseInt(document.getElementById('mysql_port').value),
            user: document.getElementById('mysql_user').value,
            password: document.getElementById('mysql_password').value,
            database: document.getElementById('mysql_database').value,
            charset: document.getElementById('mysql_charset').value
        };
        
        // ClickHouseé…ç½®
        formData.clickhouse = {
            host: document.getElementById('clickhouse_host').value,
            port: parseInt(document.getElementById('clickhouse_port').value),
            user: document.getElementById('clickhouse_user').value,
            password: document.getElementById('clickhouse_password').value,
            database: document.getElementById('clickhouse_database').value
        };
        
        // è¿ç§»ä»»åŠ¡é…ç½®
        const tables = [];
        const tableConfigs = document.querySelectorAll('.table-config');
        tableConfigs.forEach(config => {
            const mysqlTable = config.querySelector('input[name^="mysql_table_"]').value;
            const chTable = config.querySelector('input[name^="ch_table_"]').value;
            const batchSize = config.querySelector('input[name^="batch_size_"]').value;
            const verify = config.querySelector('input[name^="verify_"]').checked;
            
            if (mysqlTable && chTable) {
                const table = {
                    mysql_table: mysqlTable,
                    ch_table: chTable
                };
                if (batchSize) {
                    table.batch_size = parseInt(batchSize);
                }
                table.verify = verify;
                tables.push(table);
            }
        });
        
        formData.migration = {
            tables: tables,
            default_batch_size: parseInt(document.getElementById('default_batch_size').value),
            default_verify: document.getElementById('default_verify').checked,
            log_interval: parseInt(document.getElementById('log_interval').value),
            progress_bar_width: 40
        };
        
        // æ—¥å¿—é…ç½®
        formData.logging = {
            level: document.getElementById('logging_level').value,
            format: '%(asctime)s - %(levelname)s - %(message)s',
            date_format: '%Y-%m-%d %H:%M:%S',
            file_prefix: document.getElementById('file_prefix').value,
            console_output: document.getElementById('console_output').checked
        };
        
        // æ€§èƒ½é…ç½®
        formData.performance = {
            mysql_fetch_size: parseInt(document.getElementById('mysql_fetch_size').value),
            clickhouse_max_insert_block_size: 1048576,
            connection_timeout: parseInt(document.getElementById('connection_timeout').value),
            read_timeout: parseInt(document.getElementById('read_timeout').value)
        };
        
        // é«˜çº§é€‰é¡¹
        formData.advanced = {
            drop_table_before_create: document.getElementById('drop_table_before_create').checked,
            create_database_if_not_exists: false,
            skip_empty_tables: document.getElementById('skip_empty_tables').checked,
            continue_on_error: document.getElementById('continue_on_error').checked
        };
        
        // é£ä¹¦é…ç½®
        formData.feishu = {
            enabled: document.getElementById('feishu_enabled').checked,
            webhook_url: document.getElementById('feishu_webhook_url').value,
            notify_on_start: document.getElementById('notify_on_start').checked,
            notify_on_success: document.getElementById('notify_on_success').checked,
            notify_on_failure: document.getElementById('notify_on_failure').checked,
            notify_on_progress: false,
            progress_notify_interval: 300,
            mention_users: [],
            mention_all: false,
            env_name: document.getElementById('feishu_env_name').value,
            project_name: document.getElementById('feishu_project_name').value
        };
        
        return formData;
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
        try {
            const config = collectFormData();
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            if (result.success) {
                showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showMessage('ä¿å­˜å¤±è´¥: ' + result.message, 'error');
            }
        } catch (error) {
            showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å¯åŠ¨è¿ç§»
    async function startMigration() {
        if (!confirm('ç¡®å®šè¦å¯åŠ¨è¿ç§»ä»»åŠ¡å—ï¼Ÿ')) {
            return;
        }
        
        try {
            const config = collectFormData();
            
            // éªŒè¯è¡¨é…ç½®
            if (!config.migration.tables || config.migration.tables.length === 0) {
                showMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè¡¨é…ç½®', 'error');
                return;
            }
            
            const taskName = prompt('è¯·è¾“å…¥ä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼‰:', `è¿ç§»ä»»åŠ¡_${new Date().toLocaleString('zh-CN')}`);
            
            const response = await fetch('/api/task/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    config: config,
                    task_name: taskName || undefined
                })
            });
            
            const result = await response.json();
            if (result.success) {
                showMessage(`ä»»åŠ¡å·²å¯åŠ¨ï¼ä»»åŠ¡ID: ${result.task_id}`, 'success');
                // åˆ·æ–°æœ€è¿‘ä»»åŠ¡åˆ—è¡¨
                loadRecentTasks();
                setTimeout(() => {
                    window.location.href = `/task/${result.task_id}`;
                }, 2000);
            } else {
                showMessage('å¯åŠ¨å¤±è´¥: ' + result.message, 'error');
            }
        } catch (error) {
            showMessage('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message, type) {
        const msgDiv = document.getElementById('message');
        msgDiv.textContent = message;
        msgDiv.className = `message ${type}`;
        msgDiv.style.display = 'block';
        
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 5000);
    }

    // é¡µé¢åŠ è½½æ—¶åŠ è½½é…ç½®å’Œæœ€è¿‘ä»»åŠ¡
    window.onload = function() {
        loadConfig();
        loadRecentTasks();
        // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡æœ€è¿‘ä»»åŠ¡
        setInterval(loadRecentTasks, 10000);
    };
</script>
{% endblock %}
